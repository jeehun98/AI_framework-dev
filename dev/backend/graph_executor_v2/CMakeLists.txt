cmake_minimum_required(VERSION 3.26)
project(graph_executor_v2 LANGUAGES CXX CUDA)

find_package(Python 3.12 COMPONENTS Interpreter Development.Module REQUIRED)
find_package(pybind11 CONFIG REQUIRED)
find_package(CUDAToolkit REQUIRED)

# ì•„í‚¤í…ì²˜ëŠ” CMake í‘œì¤€ ë³€ìˆ˜ë¡œ ì§€ì • (ê¶Œì¥). 86 = Ampere
# ì—¬ëŸ¬ ê°œë©´ ê³µë°±ìœ¼ë¡œ ë‚˜ì—´: e.g. 75;86;89
set(CMAKE_CUDA_ARCHITECTURES 86)

set(SRC
  src/bindings_min_api.cpp
  src/launch_table.cpp
  src/my_kernels.cu
)

pybind11_add_module(graph_executor_v2 MODULE ${SRC})

# í‘œì¤€ ì„¤ì •
target_compile_features(graph_executor_v2 PRIVATE cxx_std_17)
set_target_properties(graph_executor_v2 PROPERTIES
  CUDA_STANDARD 17
  CUDA_SEPARABLE_COMPILATION ON
  POSITION_INDEPENDENT_CODE ON
)

# ğŸ”§ MSVC ì „ìš© ì˜µì…˜ì€ CXXì—ë§Œ ì ìš© (CUDAì—ëŠ” ì§ì ‘ ë„£ì§€ ì•ŠìŒ)
if (MSVC)
  target_compile_options(graph_executor_v2 PRIVATE
    $<$<COMPILE_LANGUAGE:CXX>:/bigobj;/W3;/EHsc;/O2;/MD>
  )
else()
  target_compile_options(graph_executor_v2 PRIVATE
    $<$<COMPILE_LANGUAGE:CXX>:-Wall;-Wextra;-O2>
  )
endif()

# ğŸ”§ CUDA ì „ìš© ì˜µì…˜ì´ í•„ìš”í•˜ë©´ ì´ë ‡ê²Œ -Xcompilerë¡œ ë„˜ê¹€
target_compile_options(graph_executor_v2 PRIVATE
  $<$<COMPILE_LANGUAGE:CUDA>:-Xcompiler=/EHsc;-Xcompiler=/O2;-Xcompiler=/MD>
)

# ë§í¬
target_link_libraries(graph_executor_v2 PRIVATE
  CUDA::cudart
  CUDA::cublas
  # CUDA::cublasLt  # í•„ìš” ì‹œ
)

target_include_directories(graph_executor_v2 PRIVATE
  ${CUDAToolkit_INCLUDE_DIRS}
  ${Python_INCLUDE_DIRS}
  include
)

# ëª¨ë“ˆ ì´ë¦„ì„ í™•ì‹¤íˆ ê³ ì •
set_target_properties(graph_executor_v2 PROPERTIES OUTPUT_NAME "graph_executor_v2")

# ìœˆë„ìš°(.pydëŠ” DLL ì·¨ê¸‰)ì™€ ë¦¬ëˆ…ìŠ¤ ëª¨ë‘ ì»¤ë²„
install(TARGETS graph_executor_v2
        LIBRARY DESTINATION .
        RUNTIME DESTINATION .
        ARCHIVE DESTINATION .)
